# Этап 3: Рефакторинг ядра аддона

## Цель
Выделить логику в отдельные модули, создать модульную архитектуру с изолированными компонентами.

## Выполненные задачи ✅

### 3.1. Модуль мониторинга маны (`modules/mana_monitor.lua`)
- **Изоляция бизнес-логики**: отслеживание порогов маны отделено от UI
- **Callback система**: `onManaThresholdReached`, `onPowerTypeChanged` для интеграции с UI
- **События WoW API**: `UNIT_MANA`, `UNIT_MAXMANA`, `UNIT_DISPLAYPOWER`
- **Тестирование**: команды `/toom testmana`, глобальная функция `T_OoM_ManaMonitorTest()`

### 3.2. Модуль отображения UI (`modules/ui_display.lua`)
- **Изоляция UI логики**: создание фреймов, показ сообщений, отправка в чат
- **Интеграция через callback**: получает готовые события от ManaMonitor
- **Управление отображением**: автоматическое скрытие, настройки внешнего вида
- **Тестирование**: команды `/toom testui`, `/toom testui_mana`

### 3.3. Координатор модулей (`T-OoM.lua`)
- **Упрощение основного файла**: только инициализация и связывание модулей
- **Полная локализация**: весь хардкод текста перенесен в систему локализации
- **Убраны дублирующие команды**: оставлены только основные slash-команды
- **Диагностика**: команда `/toom status` для проверки системы

## Архитектура после рефакторинга

```
T-OoM.lua (координатор)
    ↓
modules/loader.lua (система загрузки)
    ↓
modules/settings.lua ← используют все модули
modules/localization.lua ← используют все модули
    ↓
modules/mana_monitor.lua → callback → modules/ui_display.lua
```

## Принципы изоляции

- **ManaMonitor** не знает о UI, только отслеживает пороги
- **UIDisplay** не знает о логике порогов, только отображает события
- **Общие данные** через Settings модуль
- **Локализация** доступна всем модулям

## Команды для тестирования

- `/toom test` - быстрый тест всех модулей
- `/toom testmana` - тест мониторинга маны
- `/toom testui` - тест UI отображения
- `/toom testui_mana` - тест UI с событиями маны
- `/toom status` - диагностика глобальных функций

## Результат

Модульная архитектура готова к добавлению GUI интерфейса (Этап 4).
